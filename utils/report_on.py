# Update Ontario Public Health Ontario data in Google Sheets #
# Author: Jean-Paul R. Soucy #

# This script is imported by utils/report_on.R

import requests
import json
import uuid

# function: make POST request for XLSX export
def post_xlsx(path, auth, aid, ua, data_json):
    # define URL
    url = 'https://wabi-canada-central-redirect.analysis.windows.net/export/xlsx'
    
    # define headers
    headers = {
      'User-Agent': ua,
      'Accept': 'application/json, text/plain, */*',
      'Accept-Language': 'en-US,en;q=0.5',
      'Accept-Encoding': 'gzip, deflate, br',
      'ActivityId': aid,
      'RequestId': str(uuid.uuid4()),
      'Authorization': auth,
      'Content-Type': 'application/json;charset=UTF-8',
      'X-PowerBI-HostEnv': 'Embed for Organization',
      'Origin': 'https://app.powerbi.com',
      'DNT': '1',
      'Connection': 'keep-alive',
      'Referer': 'https://app.powerbi.com/',
      'Sec-Fetch-Dest': 'empty',
      'Sec-Fetch-Mode': 'cors',
      'Sec-Fetch-Site': 'cross-site',
      'Sec-GPC': '1',
      'TE': 'trailers'
    }
    
    # make POST request
    response = requests.post(url, headers=headers, data=data_json)
    
    # write repsonse to file
    with open(path, 'wb') as f:
      f.write(response.content)

# function: retrieve case data
def on_case_data(path, auth, aid, ua, start_date, end_date, hr):

  # define payload
  data_payload = {"exportDataType":0,"executeSemanticQueryRequest":{"version":"1.0.0","queries":[{"Query":{"Commands":[{"SemanticQueryDataShapeCommand":{"Query":{"Version":2,"From":[{"Name":"o","Entity":"overalldatetable","Type":0},{"Name":"t","Entity":"casedata","Type":0},{"Name":"p","Entity":"phupoptrendsage","Type":0},{"Name":"o1","Entity":"overallphutable","Type":0},{"Name":"c","Entity":"caseindicatortable","Type":0}],"Select":[{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"},"Name":"overalldatetable.Week start date","NativeReferenceName":"Week start date"},{"Measure":{"Expression":{"SourceRef":{"Source":"t"}},"Property":"Number of cases"},"Name":"casedata.Number of cases","NativeReferenceName":"Number of cases"},{"Measure":{"Expression":{"SourceRef":{"Source":"p"}},"Property":"Population"},"Name":"phupoptrendsage.Population","NativeReferenceName":"Population"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week end date"}},"Function":3},"Name":"Min(overalldatetable.Week end date)","NativeReferenceName":"Week end date"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Surveillance period"}},"Function":3},"Name":"Min(overalldatetable.Surveillance period)","NativeReferenceName":"Surveillance period"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Surveillance week"}},"Function":3},"Name":"Min(overalldatetable.Surveillance week)","NativeReferenceName":"Surveillance week"},{"Measure":{"Expression":{"SourceRef":{"Source":"t"}},"Property":"Cases per 100,000 population"},"Name":"casedata.Cases per 100,000 population","NativeReferenceName":"Cases per 100,000 population"}],"Where":[{"Condition":{"And":{"Left":{"Comparison":{"ComparisonKind":2,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}},"Right":{"Literal":{"Value":"datetime'2023-04-09T00:00:00'"}}}},"Right":{"Comparison":{"ComparisonKind":3,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}},"Right":{"Literal":{"Value":"datetime'2024-04-01T00:00:00'"}}}}}}},{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"o1"}},"Property":"Public health unit"}}],"Values":[[{"Literal":{"Value":"'Ontario'"}}]]}}},{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"indicator_name"}}],"Values":[[{"Literal":{"Value":"'COVID-19'"}}]]}}},{"Condition":{"Not":{"Expression":{"Comparison":{"ComparisonKind":0,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"indicator_name"}},"Right":{"Literal":{"Value":"null"}}}}}}},{"Condition":{"Comparison":{"ComparisonKind":2,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2014-08-24T00:00:00'"}},"TimeUnit":5}}}}},{"Condition":{"Comparison":{"ComparisonKind":4,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2024-03-31T00:00:00'"}},"TimeUnit":5}}}}}],"OrderBy":[{"Direction":1,"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}}}]},"Binding":{"Primary":{"Groupings":[{"Projections":[0,1,2,3,4,5,6],"Subtotal":0}]},"DataReduction":{"Primary":{"Top":{"Count":1000000}},"Secondary":{"Top":{"Count":100}}},"Version":1}}},{"ExportDataCommand":{"Columns":[{"QueryName":"overalldatetable.Week start date","Name":"Week start date"},{"QueryName":"casedata.Number of cases","Name":"Number of cases"},{"QueryName":"phupoptrendsage.Population","Name":"Population"},{"QueryName":"Min(overalldatetable.Week end date)","Name":"Week end date"},{"QueryName":"Min(overalldatetable.Surveillance period)","Name":"Surveillance period"},{"QueryName":"Min(overalldatetable.Surveillance week)","Name":"Surveillance week"},{"QueryName":"casedata.Cases per 100,000 population","Name":"Cases per 100,000 population"}],"Ordering":[0,1,2,3,4,5,6],"FiltersDescription":""}}]}}],"cancelQueries":[],"modelId":4290342,"userPreferredLocale":"en-CA"},"artifactId":3894792}
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][0]["Condition"]["And"]["Left"]["Comparison"]["Right"]["Literal"]["Value"] = start_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][4]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = start_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][0]["Condition"]["And"]["Right"]["Comparison"]["Right"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][5]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][1]["Condition"]["In"]["Values"][0][0]["Literal"]["Value"] = hr
  # add additional start and end dates
  data_json = json.dumps(data_payload)

  # POST request and save file
  post_xlsx(path, auth, aid, ua, data_json)

# function: retrieve outcome data (deaths)
def on_outcome_data_1(path, auth, aid, ua, start_date, end_date, hr):
  
  # define payload
  data_payload = {"exportDataType":0,"executeSemanticQueryRequest":{"version":"1.0.0","queries":[{"Query":{"Commands":[{"SemanticQueryDataShapeCommand":{"Query":{"Version":2,"From":[{"Name":"o","Entity":"overalldatetable","Type":0},{"Name":"o1","Entity":"outcomealltrends","Type":0},{"Name":"p","Entity":"phupoptrendsage","Type":0},{"Name":"o2","Entity":"overallphutable","Type":0},{"Name":"o11","Entity":"outcomeindtable","Type":0},{"Name":"c","Entity":"caseindicatortable","Type":0}],"Select":[{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"},"Name":"overalldatetable.Week start date","NativeReferenceName":"Week start date"},{"Measure":{"Expression":{"SourceRef":{"Source":"o1"}},"Property":"Number"},"Name":"outcomealltrends.Number","NativeReferenceName":"Number"},{"Measure":{"Expression":{"SourceRef":{"Source":"p"}},"Property":"Population"},"Name":"phupoptrendsage.Population","NativeReferenceName":"Population"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week end date"}},"Function":3},"Name":"Min(overalldatetable.Week end date)","NativeReferenceName":"Week end date"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Surveillance period"}},"Function":3},"Name":"Min(overalldatetable.Surveillance period)","NativeReferenceName":"Surveillance period"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Surveillance week"}},"Function":3},"Name":"Min(overalldatetable.Surveillance week)","NativeReferenceName":"Surveillance week"},{"Measure":{"Expression":{"SourceRef":{"Source":"o1"}},"Property":"Number per 100,000 population"},"Name":"outcomealltrends.Number per 100,000 population","NativeReferenceName":"Number per 100,000 population"}],"Where":[{"Condition":{"And":{"Left":{"Comparison":{"ComparisonKind":2,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}},"Right":{"Literal":{"Value":"datetime'2023-04-09T00:00:00'"}}}},"Right":{"Comparison":{"ComparisonKind":3,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}},"Right":{"Literal":{"Value":"datetime'2024-04-01T00:00:00'"}}}}}}},{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"o2"}},"Property":"Public health unit"}}],"Values":[[{"Literal":{"Value":"'Ontario'"}}]]}}},{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"o11"}},"Property":"indicator_name"}}],"Values":[[{"Literal":{"Value":"'COVID-19 deaths'"}}]]}}},{"Condition":{"Not":{"Expression":{"Comparison":{"ComparisonKind":0,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"indicator_name"}},"Right":{"Literal":{"Value":"null"}}}}}}},{"Condition":{"Comparison":{"ComparisonKind":2,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2014-08-24T00:00:00'"}},"TimeUnit":5}}}}},{"Condition":{"Comparison":{"ComparisonKind":4,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2024-03-31T00:00:00'"}},"TimeUnit":5}}}}}],"OrderBy":[{"Direction":1,"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}}}]},"Binding":{"Primary":{"Groupings":[{"Projections":[0,1,2,3,4,5,6],"Subtotal":0}]},"DataReduction":{"Primary":{"Top":{"Count":1000000}},"Secondary":{"Top":{"Count":100}}},"Version":1}}},{"ExportDataCommand":{"Columns":[{"QueryName":"overalldatetable.Week start date","Name":"Week start date"},{"QueryName":"outcomealltrends.Number","Name":"Number"},{"QueryName":"phupoptrendsage.Population","Name":"Population"},{"QueryName":"Min(overalldatetable.Week end date)","Name":"Week end date"},{"QueryName":"Min(overalldatetable.Surveillance period)","Name":"Surveillance period"},{"QueryName":"Min(overalldatetable.Surveillance week)","Name":"Surveillance week"},{"QueryName":"outcomealltrends.Number per 100,000 population","Name":"Number per 100,000 population"}],"Ordering":[0,1,2,3,4,5,6],"FiltersDescription":""}}]}}],"cancelQueries":[],"modelId":4290342,"userPreferredLocale":"en-CA"},"artifactId":3894792}
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][0]["Condition"]["And"]["Left"]["Comparison"]["Right"]["Literal"]["Value"] = start_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][4]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = start_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][0]["Condition"]["And"]["Right"]["Comparison"]["Right"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][5]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][1]["Condition"]["In"]["Values"][0][0]["Literal"]["Value"] = hr
  data_json = json.dumps(data_payload)

  # POST request and save file
  post_xlsx(path, auth, aid, ua, data_json)

# function: retrieve outcome data (hospital admissions)
def on_outcome_data_2(path, auth, aid, ua, start_date, end_date, hr):
  
  # define payload
  data_payload = {"exportDataType":0,"executeSemanticQueryRequest":{"version":"1.0.0","queries":[{"Query":{"Commands":[{"SemanticQueryDataShapeCommand":{"Query":{"Version":2,"From":[{"Name":"o","Entity":"overalldatetable","Type":0},{"Name":"o1","Entity":"outcomealltrends","Type":0},{"Name":"p","Entity":"phupoptrendsage","Type":0},{"Name":"o2","Entity":"overallphutable","Type":0},{"Name":"o11","Entity":"outcomeindtable","Type":0},{"Name":"c","Entity":"caseindicatortable","Type":0}],"Select":[{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"},"Name":"overalldatetable.Week start date","NativeReferenceName":"Week start date"},{"Measure":{"Expression":{"SourceRef":{"Source":"o1"}},"Property":"Number"},"Name":"outcomealltrends.Number","NativeReferenceName":"Number"},{"Measure":{"Expression":{"SourceRef":{"Source":"p"}},"Property":"Population"},"Name":"phupoptrendsage.Population","NativeReferenceName":"Population"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week end date"}},"Function":3},"Name":"Min(overalldatetable.Week end date)","NativeReferenceName":"Week end date"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Surveillance period"}},"Function":3},"Name":"Min(overalldatetable.Surveillance period)","NativeReferenceName":"Surveillance period"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Surveillance week"}},"Function":3},"Name":"Min(overalldatetable.Surveillance week)","NativeReferenceName":"Surveillance week"},{"Measure":{"Expression":{"SourceRef":{"Source":"o1"}},"Property":"Number per 100,000 population"},"Name":"outcomealltrends.Number per 100,000 population","NativeReferenceName":"Number per 100,000 population"}],"Where":[{"Condition":{"And":{"Left":{"Comparison":{"ComparisonKind":2,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}},"Right":{"Literal":{"Value":"datetime'2023-04-09T00:00:00'"}}}},"Right":{"Comparison":{"ComparisonKind":3,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}},"Right":{"Literal":{"Value":"datetime'2024-04-01T00:00:00'"}}}}}}},{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"o2"}},"Property":"Public health unit"}}],"Values":[[{"Literal":{"Value":"'Ontario'"}}]]}}},{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"o11"}},"Property":"indicator_name"}}],"Values":[[{"Literal":{"Value":"'COVID-19 hospital admissions (up to January 20, 2024)'"}}]]}}},{"Condition":{"Not":{"Expression":{"Comparison":{"ComparisonKind":0,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"indicator_name"}},"Right":{"Literal":{"Value":"null"}}}}}}},{"Condition":{"Comparison":{"ComparisonKind":2,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2014-08-24T00:00:00'"}},"TimeUnit":5}}}}},{"Condition":{"Comparison":{"ComparisonKind":4,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2024-03-31T00:00:00'"}},"TimeUnit":5}}}}}],"OrderBy":[{"Direction":1,"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Week start date"}}}]},"Binding":{"Primary":{"Groupings":[{"Projections":[0,1,2,3,4,5,6],"Subtotal":0}]},"DataReduction":{"Primary":{"Top":{"Count":1000000}},"Secondary":{"Top":{"Count":100}}},"Version":1}}},{"ExportDataCommand":{"Columns":[{"QueryName":"overalldatetable.Week start date","Name":"Week start date"},{"QueryName":"outcomealltrends.Number","Name":"Number"},{"QueryName":"phupoptrendsage.Population","Name":"Population"},{"QueryName":"Min(overalldatetable.Week end date)","Name":"Week end date"},{"QueryName":"Min(overalldatetable.Surveillance period)","Name":"Surveillance period"},{"QueryName":"Min(overalldatetable.Surveillance week)","Name":"Surveillance week"},{"QueryName":"outcomealltrends.Number per 100,000 population","Name":"Number per 100,000 population"}],"Ordering":[0,1,2,3,4,5,6],"FiltersDescription":""}}]}}],"cancelQueries":[],"modelId":4290342,"userPreferredLocale":"en-CA"},"artifactId":3894792}
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][0]["Condition"]["And"]["Left"]["Comparison"]["Right"]["Literal"]["Value"] = start_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][4]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = start_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][0]["Condition"]["And"]["Right"]["Comparison"]["Right"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][5]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][1]["Condition"]["In"]["Values"][0][0]["Literal"]["Value"] = hr
  data_json = json.dumps(data_payload)
  
  # POST request and save file
  post_xlsx(path, auth, aid, ua, data_json)

# function: retrieve testing data
def on_testing_data(path, auth, aid, ua, start_date, end_date, hr):
  
  # define payload
  data_payload = {"exportDataType":0,"executeSemanticQueryRequest":{"version":"1.0.0","queries":[{"Query":{"Commands":[{"SemanticQueryDataShapeCommand":{"Query":{"Version":2,"From":[{"Name":"c","Entity":"overalldatetable","Type":0},{"Name":"t","Entity":"testingdata","Type":0},{"Name":"t1","Entity":"testingindicatortable","Type":0},{"Name":"o","Entity":"overallphutable","Type":0}],"Select":[{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"Week start date"},"Name":"casedatetable.week_start_date","NativeReferenceName":"Week start date"},{"Measure":{"Expression":{"SourceRef":{"Source":"t"}},"Property":"Total number of tests"},"Name":"testingdata.Total number of tests","NativeReferenceName":"Total number of tests"},{"Measure":{"Expression":{"SourceRef":{"Source":"t"}},"Property":"Percent positivity (%)"},"Name":"testingdata.Percent positivity (%)","NativeReferenceName":"Percent positivity (%)"},{"Measure":{"Expression":{"SourceRef":{"Source":"t"}},"Property":"Total number of positive tests"},"Name":"testingdata.Total number of positive tests","NativeReferenceName":"Total number of positive tests"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"Week end date"}},"Function":3},"Name":"Min(overalldatetable.Week end date)","NativeReferenceName":"Week end date"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"t1"}},"Property":"indicator_source"}},"Function":3},"Name":"Min(testingindicatortable.indicator_source)","NativeReferenceName":"Data source"}],"Where":[{"Condition":{"And":{"Left":{"Comparison":{"ComparisonKind":2,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"Week start date"}},"Right":{"Literal":{"Value":"datetime'2022-08-28T00:00:00'"}}}},"Right":{"Comparison":{"ComparisonKind":3,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"Week start date"}},"Right":{"Literal":{"Value":"datetime'2023-09-04T00:00:00'"}}}}}}},{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"t1"}},"Property":"indicator_name"}}],"Values":[[{"Literal":{"Value":"'SARS-CoV-2'"}}]]}}},{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Public health unit"}}],"Values":[[{"Literal":{"Value":"'Ontario'"}}]]}}},{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"t1"}},"Property":"indicator_source"}}],"Values":[[{"Literal":{"Value":"'Provincial COVID-19 Diagnostic Network'"}}]]}}},{"Condition":{"Comparison":{"ComparisonKind":2,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2014-08-24T00:00:00'"}},"TimeUnit":5}}}}},{"Condition":{"Comparison":{"ComparisonKind":4,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2023-09-03T00:00:00'"}},"TimeUnit":5}}}}}],"OrderBy":[{"Direction":1,"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"c"}},"Property":"Week start date"}}}]},"Binding":{"Primary":{"Groupings":[{"Projections":[0,1,2,3,4,5],"ShowItemsWithNoData":[0,1,2,3,4,5],"Subtotal":0}]},"DataReduction":{"Primary":{"Top":{"Count":1000000}},"Secondary":{"Top":{"Count":100}}},"Version":1}}},{"ExportDataCommand":{"Columns":[{"QueryName":"casedatetable.week_start_date","Name":"Week start date"},{"QueryName":"testingdata.Total number of tests","Name":"Total number of tests"},{"QueryName":"testingdata.Percent positivity (%)","Name":"Percent positivity (%)"},{"QueryName":"testingdata.Total number of positive tests","Name":"Total number of positive tests"},{"QueryName":"Min(overalldatetable.Week end date)","Name":"Week end date"},{"QueryName":"Min(testingindicatortable.indicator_source)","Name":"Data source"}],"Ordering":[0,1,2,3,4,5],"FiltersDescription":""}}]}}],"cancelQueries":[],"modelId":4290342,"userPreferredLocale":"en-CA"},"artifactId":3894792}
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][0]["Condition"]["And"]["Left"]["Comparison"]["Right"]["Literal"]["Value"] = start_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][4]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = start_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][0]["Condition"]["And"]["Right"]["Comparison"]["Right"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][5]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][2]["Condition"]["In"]["Values"][0][0]["Literal"]["Value"] = hr
  data_json = json.dumps(data_payload)

  # POST request and save file
  post_xlsx(path, auth, aid, ua, data_json)

# function: retrieve vaccine dose data
def on_vaccine_dose_data(path, auth, aid, ua, start_date, end_date, hr):
  
  # define payload
  data_payload = {"exportDataType":0,"executeSemanticQueryRequest":{"version":"1.0.0","queries":[{"Query":{"Commands":[{"SemanticQueryDataShapeCommand":{"Query":{"Version":2,"From":[{"Name":"v","Entity":"vaxdosevaxdata","Type":0},{"Name":"v1","Entity":"vaxindvaxdata","Type":0},{"Name":"o","Entity":"overallphutable","Type":0},{"Name":"v11","Entity":"vaxdoseproductswitch","Type":0},{"Name":"o1","Entity":"overalldatetable","Type":0}],"Select":[{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Week start date"},"Name":"vaxdosevaxdata.week_start_date","NativeReferenceName":"week_start_date"},{"Measure":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Number of doses"},"Name":"vaxdosevaxdata.Number of doses","NativeReferenceName":"# of doses"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"v1"}},"Property":"Week end date"}},"Function":4},"Name":"Max(vaxindvaxdata.Week end date)","NativeReferenceName":"Latest Week end date"},{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Dose number"},"Name":"vaxdosevaxdata.Dose number","NativeReferenceName":"Dose number"}],"Where":[{"Condition":{"Comparison":{"ComparisonKind":3,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Week start date"}},"Right":{"Literal":{"Value":"datetime'2023-09-04T00:00:00'"}}}}},{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Public health unit"}}],"Values":[[{"Literal":{"Value":"'Ontario'"}}]]}}},{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"v11"}},"Property":"Dose number or vaccine product Fields"}}],"Values":[[{"Literal":{"Value":"'''vaxdosevaxdata''[Dose number]'"}}]]}}},{"Condition":{"Comparison":{"ComparisonKind":2,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o1"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2014-08-24T00:00:00'"}},"TimeUnit":5}}}}},{"Condition":{"Comparison":{"ComparisonKind":4,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o1"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2023-09-03T00:00:00'"}},"TimeUnit":5}}}}}],"OrderBy":[{"Direction":1,"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Week start date"}}}]},"Binding":{"Primary":{"Groupings":[{"Projections":[0,1,2,3],"Subtotal":0}]},"DataReduction":{"Primary":{"Top":{"Count":1000000}},"Secondary":{"Top":{"Count":100}}},"Version":1}}},{"ExportDataCommand":{"Columns":[{"QueryName":"vaxdosevaxdata.week_start_date","Name":"'vaxdosevaxdata'[Week start date]"},{"QueryName":"vaxdosevaxdata.Number of doses","Name":"Number of doses"},{"QueryName":"Max(vaxindvaxdata.Week end date)","Name":"Latest Week end date"},{"QueryName":"vaxdosevaxdata.Dose number","Name":"Dose number"}],"Ordering":[0,3,1,2],"FiltersDescription":""}}]}}],"cancelQueries":[],"modelId":4290342,"userPreferredLocale":"en-CA"},"artifactId":3894792}
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][3]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = start_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][0]["Condition"]["Comparison"]["Right"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][4]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][1]["Condition"]["In"]["Values"][0][0]["Literal"]["Value"] = hr
  data_json = json.dumps(data_payload)

  # POST request and save file
  post_xlsx(path, auth, aid, ua, data_json)

# function: retreive vaccine coverage data
def on_vaccine_coverage_data_1(path, auth, aid, ua, start_date, end_date, hr):
  
  # define payload
  data_payload = {"exportDataType":0,"executeSemanticQueryRequest":{"version":"1.0.0","queries":[{"Query":{"Commands":[{"SemanticQueryDataShapeCommand":{"Query":{"Version":2,"From":[{"Name":"v","Entity":"vaxindvaxdata","Type":0},{"Name":"v1","Entity":"vaxindicatortable","Type":0},{"Name":"v2","Entity":"vaxindmeasureswitch","Type":0},{"Name":"o","Entity":"overallphutable","Type":0},{"Name":"o1","Entity":"overalldatetable","Type":0}],"Select":[{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Week start date"},"Name":"vaxindvaxdata.week_start_date","NativeReferenceName":"week_start_date"},{"Column":{"Expression":{"SourceRef":{"Source":"v1"}},"Property":"Indicator"},"Name":"vaxindicatortable.Indicator","NativeReferenceName":"Vaccination status"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Week start date"}},"Function":3},"Name":"Min(vaxindvaxdata.Week start date)","NativeReferenceName":"Week start date"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Week end date"}},"Function":3},"Name":"Min(vaxindvaxdata.Week end date)","NativeReferenceName":"Week end date"},{"Measure":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Cumulative coverage estimate (%)"},"Name":"vaxindvaxdata.Cumulative coverage estimate (%)","NativeReferenceName":"Cumulative coverage estimate (%)"}],"Where":[{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"v2"}},"Property":"Parameter Fields"}}],"Values":[[{"Literal":{"Value":"'''vaxindvaxdata''[Cumulative coverage estimate (%)]'"}}]]}}},{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Public health unit"}}],"Values":[[{"Literal":{"Value":"'Ontario'"}}]]}}},{"Condition":{"Comparison":{"ComparisonKind":3,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Week start date"}},"Right":{"Literal":{"Value":"datetime'2023-09-04T00:00:00'"}}}}},{"Condition":{"Comparison":{"ComparisonKind":2,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o1"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2014-08-24T00:00:00'"}},"TimeUnit":5}}}}},{"Condition":{"Comparison":{"ComparisonKind":4,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o1"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2023-09-03T00:00:00'"}},"TimeUnit":5}}}}}],"OrderBy":[{"Direction":1,"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Week start date"}}}]},"Binding":{"Primary":{"Groupings":[{"Projections":[0,1,2,3,4],"Subtotal":0}]},"DataReduction":{"Primary":{"Top":{"Count":1000000}},"Secondary":{"Top":{"Count":100}}},"Version":1}}},{"ExportDataCommand":{"Columns":[{"QueryName":"vaxindvaxdata.week_start_date","Name":"'vaxindvaxdata'[Week start date]"},{"QueryName":"vaxindicatortable.Indicator","Name":"Vaccination status"},{"QueryName":"Min(vaxindvaxdata.Week start date)","Name":"Earliest 'vaxindvaxdata'[Week start date]"},{"QueryName":"Min(vaxindvaxdata.Week end date)","Name":"Week end date"},{"QueryName":"vaxindvaxdata.Cumulative coverage estimate (%)","Name":"Cumulative coverage estimate (%)"}],"Ordering":[0,4,1,2,3],"FiltersDescription":""}}]}}],"cancelQueries":[],"modelId":4290342,"userPreferredLocale":"en-CA"},"artifactId":3894792}
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][3]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = start_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][2]["Condition"]["Comparison"]["Right"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][4]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][1]["Condition"]["In"]["Values"][0][0]["Literal"]["Value"] = hr
  data_json = json.dumps(data_payload)
  
  # POST request and save file
  post_xlsx(path, auth, aid, ua, data_json)

def on_vaccine_coverage_data_2(path, auth, aid, ua, start_date, end_date, hr):
  
  # define payload
  data_payload = {"exportDataType":0,"executeSemanticQueryRequest":{"version":"1.0.0","queries":[{"Query":{"Commands":[{"SemanticQueryDataShapeCommand":{"Query":{"Version":2,"From":[{"Name":"v","Entity":"vaxindvaxdata","Type":0},{"Name":"v1","Entity":"vaxindicatortable","Type":0},{"Name":"v2","Entity":"vaxindmeasureswitch","Type":0},{"Name":"o","Entity":"overallphutable","Type":0},{"Name":"o1","Entity":"overalldatetable","Type":0}],"Select":[{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Week start date"},"Name":"vaxindvaxdata.week_start_date","NativeReferenceName":"week_start_date"},{"Column":{"Expression":{"SourceRef":{"Source":"v1"}},"Property":"Indicator"},"Name":"vaxindicatortable.Indicator","NativeReferenceName":"Vaccination status"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Week start date"}},"Function":3},"Name":"Min(vaxindvaxdata.Week start date)","NativeReferenceName":"Week start date"},{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Week end date"}},"Function":3},"Name":"Min(vaxindvaxdata.Week end date)","NativeReferenceName":"Week end date"},{"Measure":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Cumulative number of individuals vaccinated"},"Name":"vaxindvaxdata.Cumulative number of individuals vaccinated","NativeReferenceName":"Cumulative number of individuals vaccinated"}],"Where":[{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"v2"}},"Property":"Parameter Fields"}}],"Values":[[{"Literal":{"Value":"'''vaxindvaxdata''[Cumulative number of individuals vaccinated]'"}}]]}}},{"Condition":{"In":{"Expressions":[{"Column":{"Expression":{"SourceRef":{"Source":"o"}},"Property":"Public health unit"}}],"Values":[[{"Literal":{"Value":"'Ontario'"}}]]}}},{"Condition":{"Comparison":{"ComparisonKind":3,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Week start date"}},"Right":{"Literal":{"Value":"datetime'2023-09-04T00:00:00'"}}}}},{"Condition":{"Comparison":{"ComparisonKind":2,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o1"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2014-08-24T00:00:00'"}},"TimeUnit":5}}}}},{"Condition":{"Comparison":{"ComparisonKind":4,"Left":{"Column":{"Expression":{"SourceRef":{"Source":"o1"}},"Property":"Week start date"}},"Right":{"DateSpan":{"Expression":{"Literal":{"Value":"datetime'2023-09-03T00:00:00'"}},"TimeUnit":5}}}}}],"OrderBy":[{"Direction":1,"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"v"}},"Property":"Week start date"}}}]},"Binding":{"Primary":{"Groupings":[{"Projections":[0,1,2,3,4],"Subtotal":0}]},"DataReduction":{"Primary":{"Top":{"Count":1000000}},"Secondary":{"Top":{"Count":100}}},"Version":1}}},{"ExportDataCommand":{"Columns":[{"QueryName":"vaxindvaxdata.week_start_date","Name":"'vaxindvaxdata'[Week start date]"},{"QueryName":"vaxindicatortable.Indicator","Name":"Vaccination status"},{"QueryName":"Min(vaxindvaxdata.Week start date)","Name":"Earliest 'vaxindvaxdata'[Week start date]"},{"QueryName":"Min(vaxindvaxdata.Week end date)","Name":"Week end date"},{"QueryName":"vaxindvaxdata.Cumulative number of individuals vaccinated","Name":"Cumulative number of individuals vaccinated"}],"Ordering":[0,4,1,2,3],"FiltersDescription":""}}]}}],"cancelQueries":[],"modelId":4290342,"userPreferredLocale":"en-CA"},"artifactId":3894792}
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][3]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = start_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][2]["Condition"]["Comparison"]["Right"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][4]["Condition"]["Comparison"]["Right"]["DateSpan"]["Expression"]["Literal"]["Value"] = end_date
  data_payload["executeSemanticQueryRequest"]["queries"][0]["Query"]["Commands"][0]["SemanticQueryDataShapeCommand"]["Query"]["Where"][1]["Condition"]["In"]["Values"][0][0]["Literal"]["Value"] = hr
  data_json = json.dumps(data_payload)
  
  # POST request and save file
  post_xlsx(path, auth, aid, ua, data_json)
